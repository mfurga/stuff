#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

// https://sourceware.org/glibc/wiki/MallocInternals
void print_chunk_info(void *mem) {
  size_t *chunk = mem;
  chunk -= 1;

  size_t sz = (*chunk & ~7ull);
  int prev_in_use = *chunk & 1;
  int mmaped = (*chunk >> 1) & 1;
  int allocated = (*chunk >> 1) & 1;

  size_t *next_chunk = chunk + (sz / sizeof(size_t));
  int in_use = *next_chunk & 1;

  printf("addr: %p (8B + %luB) [%c%c%c] [%s]\n",
    mem,
    sz - 8,
    "pP"[prev_in_use],
    "mM"[mmaped],
    "aA"[allocated],
    in_use == 1 ? "ALLOCATED" : "FREED"
  );
}

int main(int argc, char **argv) {
  void *p1 = malloc(0);
  void *p2 = malloc(1024ULL * 1024ULL * 1024ULL * 27);

  print_chunk_info(p1);
  print_chunk_info(p2);

  free(p2);

  void *p3 = malloc(24);
  print_chunk_info(p3);

/*
  printf("addr: %p\n", p1);
  printf("size: %lu\n", *(p1 - 1));
  printf("addr: %p\n", p2);
  printf("size: %lu\n", *(p2 - 1));
*/

  return 0;
}
