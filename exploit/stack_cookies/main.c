#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>

#define PORT 4000

void handle(int conn) {
  char buf[16];

  /* buffer overflow */
  read(conn, &buf, 1024);
}

int main(void) {
  struct sockaddr_in addr;
  addr.sin_family = AF_INET;
  addr.sin_addr.s_addr = htonl(INADDR_ANY);
  addr.sin_port = htons(PORT);

  int s = socket(AF_INET, SOCK_STREAM, 0);
  if (s == -1) {
    puts("socket error");
    return 1;
  }

  int yes = 1;
  if (setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(int))) {
    puts("setsockopt error");
    return 1;
  }

  if (bind(s, (struct sockaddr *)&addr, sizeof(addr)) == -1) {
    puts("bind error");
    return 1;
  }

  if (listen(s, 5) == -1) {
    puts("listen error");
    return 1;
  }

  printf("waiting for connections (%d) ...\n", PORT);

  while (1) {
    int conn = accept(s, NULL, 0);
    printf("new connection: %d\n", conn);

    pid_t pid = fork();
    if (pid == 0) {
      dup2(conn, STDOUT_FILENO);
      dup2(conn, STDERR_FILENO);

      handle(conn);

      shutdown(conn, SHUT_RDWR);
      return 0;
    }

    close(conn);
    waitpid(pid, NULL, 0);
  }

  return 0;
}

